<!DOCTYPE html>
<html>
<head>
    <title>MyDB Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .sql-input { width: 100%; margin: 5px 0; }
        .result { background: #f5f5f5; padding: 10px; margin: 5px 0; white-space: pre-wrap; }
        .debug-log { background: #000; color: #0f0; padding: 10px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        button { padding: 8px 16px; margin: 5px; }
        .status { font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>MyDB Debug Test - 删除后无法插入问题排查</h1>
    
    <div class="test-section">
        <h3>数据库状态</h3>
        <div id="status" class="status">正在初始化...</div>
    </div>

    <div class="test-section">
        <h3>执行SQL</h3>
        <textarea id="sqlInput" class="sql-input" rows="3" placeholder="输入SQL命令...">create table images (id int, device_id string, created_at timestamp, hash string, blob_key string, description string)</textarea>
        <br>
        <button onclick="executeSql()">执行SQL</button>
        <button onclick="runFullTest()">运行完整测试</button>
        <button onclick="clearLog()">清除日志</button>
        <div id="result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>调试日志</h3>
        <div id="debugLog" class="debug-log"></div>
    </div>

    <div class="test-section">
        <h3>预设测试场景</h3>
        <button onclick="runScenario1()">场景1: 基本INSERT/DELETE</button>
        <button onclick="runScenario2()">场景2: 删除后重新INSERT</button>
        <button onclick="runScenario3()">场景3: 用户报告的问题</button>
    </div>

    <script src="bin/mydb.js"></script>
    <script>
        let db = null;
        let originalConsoleError = console.error;
        let originalConsoleLog = console.log;

        // 拦截console输出以显示调试日志
        console.error = function(...args) {
            const msg = args.join(' ');
            if (msg.includes('[DEBUG-')) {
                appendDebugLog(msg);
            }
            originalConsoleError.apply(console, args);
        };

        console.log = function(...args) {
            const msg = args.join(' ');
            if (msg.includes('[DEBUG-')) {
                appendDebugLog(msg);
            }
            originalConsoleLog.apply(console, args);
        };

        function appendDebugLog(message) {
            const logDiv = document.getElementById('debugLog');
            logDiv.textContent += message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = '';
            document.getElementById('result').textContent = '';
        }

        async function initDB() {
            try {
                document.getElementById('status').textContent = '正在加载WASM模块...';
                const Module = await MyDB();
                
                document.getElementById('status').textContent = '正在初始化持久化存储...';
                await ensurePersistent(Module);
                
                const mydb_open = Module.cwrap('mydb_open_with_ems', 'number', ['string']);
                const handle = mydb_open('debug_test.db');
                
                if (!handle) {
                    throw new Error('无法打开数据库');
                }
                
                db = {
                    Module: Module,
                    handle: handle,
                    execute: Module.cwrap('mydb_execute_json_with_ems', 'number', ['number','number','number'])
                };
                
                document.getElementById('status').textContent = '数据库已就绪！';
                appendDebugLog('数据库初始化完成');
            } catch (error) {
                document.getElementById('status').textContent = '初始化失败: ' + error.message;
                console.error('Init error:', error);
            }
        }

        function ensurePersistent(Module) {
            return new Promise((resolve, reject) => {
                try { Module.FS.mkdir('/persistent'); } catch (e) {}
                try { Module.FS.mount(Module.IDBFS || IDBFS, {}, '/persistent'); } catch (e) {
                    console.warn('mount IDBFS failed (may be already mounted)', e);
                }
                Module.FS.syncfs(true, function(err) {
                    if (err) {
                        console.error('FS.syncfs(true) error', err);
                        reject(err);
                    } else {
                        console.log('IDBFS -> MEMFS sync complete');
                        resolve();
                    }
                });
            });
        }

        function allocString(Module, str) {
            if (Module.allocateUTF8) return Module.allocateUTF8(str);
            var len = (Module.lengthBytesUTF8 ? Module.lengthBytesUTF8(str) : (new TextEncoder().encode(str).length)) + 1;
            var ptr = Module._malloc(len);
            if (!ptr) throw new Error('allocString: malloc failed');
            if (Module.stringToUTF8) {
                Module.stringToUTF8(str, ptr, len);
                return ptr;
            }
            if (Module.HEAPU8) {
                var encoder = new TextEncoder();
                var bytes = encoder.encode(str);
                Module.HEAPU8.set(bytes, ptr);
                Module.HEAPU8[ptr + bytes.length] = 0;
                return ptr;
            }
            Module._free(ptr);
            throw new Error('allocString: no method to write string into wasm memory');
        }

        function executeSql() {
            if (!db) {
                alert('数据库未初始化');
                return;
            }

            const sql = document.getElementById('sqlInput').value.trim();
            if (!sql) return;

            try {
                const sqlPtr = allocString(db.Module, sql);
                const outPtrPtr = db.Module._malloc(4);
                
                appendDebugLog(`执行SQL: ${sql}`);
                const rc = db.execute(db.handle, sqlPtr, outPtrPtr);
                
                const outPtr = db.Module.getValue(outPtrPtr, 'i32');
                let result = null;
                if (outPtr) {
                    result = db.Module.UTF8ToString(outPtr);
                    db.Module._free(outPtr);
                }
                
                db.Module._free(outPtrPtr);
                db.Module._free(sqlPtr);
                
                document.getElementById('result').textContent = result || '(无返回结果)';
                
                // 持久化更改
                try {
                    db.Module.FS.syncfs(false, function(err) {
                        if (err) console.error('Failed to persist DB to IDBFS:', err);
                        else console.log('Persisted /persistent -> IDBFS');
                    });
                } catch (e) {
                    console.error('DB persist error:', e);
                }
                
            } catch (error) {
                document.getElementById('result').textContent = 'Error: ' + error.message;
                console.error('SQL execution error:', error);
            }
        }

        function runFullTest() {
            const commands = [
                "create table images (id int, device_id string, created_at timestamp, hash string, blob_key string, description string)",
                "use images", 
                "insert into images 1 device001 1696636800 hash1 blobkey1 ''",
                "insert into images 2 device001 1696636801 hash2 blobkey2 ''",
                "select id, device_id, created_at, hash, blob_key, description from images order by created_at desc",
                "select id from images order by id desc limit 1 offset 0",
                "delete from images where id = 1",
                "delete from images where id = 2", 
                "select id, device_id, created_at, hash, blob_key, description from images order by created_at desc",
                "select id from images order by id desc limit 1 offset 0",
                "insert into images 3 device001 1696636802 hash3 blobkey3 ''",
                "select id, device_id, created_at, hash, blob_key, description from images order by created_at desc"
            ];

            runCommands(commands);
        }

        function runScenario1() {
            const commands = [
                "create table test1 (id int, name string, value int)",
                "use test1",
                "insert into test1 1 name1 100", 
                "select * from test1",
                "delete from test1 where id = 1",
                "select * from test1"
            ];
            runCommands(commands);
        }

        function runScenario2() {
            const commands = [
                "create table test2 (id int, data string)",
                "use test2",
                "insert into test2 1 data1",
                "delete from test2 where id = 1",
                "insert into test2 2 data2",
                "select * from test2"
            ];
            runCommands(commands);
        }

        function runScenario3() {
            appendDebugLog('=== 用户报告的问题场景 ===');
            runFullTest();
        }

        function runCommands(commands) {
            clearLog();
            let index = 0;
            
            function runNext() {
                if (index >= commands.length) {
                    appendDebugLog('=== 测试完成 ===');
                    return;
                }
                
                const cmd = commands[index++];
                document.getElementById('sqlInput').value = cmd;
                executeSql();
                
                // 短暂延迟以便观察日志
                setTimeout(runNext, 100);
            }
            
            runNext();
        }

        // 页面加载时初始化
        window.onload = initDB;
    </script>
</body>
</html>

